<!DOCTYPE html>
<html>
<head>
    <title>ROS 2 Graph Viewer</title>
    <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
    <script src="https://unpkg.com/cytoscape-svg@0.4.0/cytoscape-svg.js"></script>
    <style>
        /* CSSã‚¹ã‚¿ã‚¤ãƒ«: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æœ›ã«ã‚ˆã‚Šã€åˆæœŸå€¤ (800px) ã‚’ç¶­æŒ */
        #cy { width: 100%; height: 800px; display: block; border: 1px solid #ddd; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; }
        .controls { margin-bottom: 20px; background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #details-panel { border: 1px solid #ccc; background-color: #e9ecef; padding: 10px; margin-top: 10px; white-space: pre-wrap; height: 200px; overflow: auto; border-radius: 4px; font-family: monospace; font-size: 12px; }
        button { padding: 8px 15px; background-color: #1E90FF; color: white; border: none; border-radius: 4é‘¿px; cursor: pointer; font-size: 14px; }
        button:hover { background-color: #1c7ed6; }
    </style>
</head>
<body>

    <h1>ROS 2 Graph Viewer (Jinja2 Generated)</h1>

    <div class="controls">
        <button id="export-svg-btn">Export as SVG</button>
        <div id="details-panel">
            ã‚¯ãƒªãƒƒã‚¯ã—ãŸè¦ç´ ï¼ˆãƒãƒ¼ãƒ‰ã€ãƒˆãƒ”ãƒƒã‚¯ï¼‰ã®è©³ç´°æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
        </div>
    </div>

    <div id="cy"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // Dagre ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ç™»éŒ²
            if (typeof cytoscape.use === 'function' && typeof cytoscapeDagre === 'function') {
                cytoscape.use(cytoscapeDagre);
                console.log("Dagre layout successfully registered.");
            } else {
                console.error("Failed to register Dagre. Falling back to default 'cose'.");
            }

            // SVGã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ‹¡å¼µã‚’ç™»éŒ² 
            if (typeof cytoscape.use === 'function' && typeof cytoscapeSvg === 'function') {
                cytoscape.use(cytoscapeSvg);
                console.log("SVG extension successfully registered.");
            } else {
                console.error("Failed to register SVG extension. SVG export functionality may be unavailable.");
            }

            // --- ãƒ‡ãƒ¼ã‚¿ã®æ³¨å…¥ (Jinja2ã«ã‚ˆã£ã¦ã“ã“ãŒç½®ãæ›ãˆã‚‰ã‚Œã¾ã™) ---
            const elementsData = {{ elements_data | tojson }};
            // ---------------------------------------------------------

            let layoutToUse = (typeof cytoscapeDagre === 'function') ? 'dagre' : 'cose';

            // === Cytoscape.jsã®åˆæœŸåŒ– ===
            let cy = cytoscape({
                container: document.getElementById('cy'),
                // ã“ã“ã§æ³¨å…¥ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                elements: elementsData.elements,

                // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®š: ãƒãƒ¼ãƒ‰é–“éš”ã¯åˆæœŸå€¤(50)ã‚’ç¶­æŒ
                layout: {
                    name: layoutToUse,
                    rankDir: 'TB', // Top to Bottom (ä¸Šã‹ã‚‰ä¸‹ã¸)
                    padding: 50,
                    nodeDimensionsIncludeLabels: true,
                },

                // ğŸ’¥ ä¿®æ­£ç‚¹ï¼šã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š ğŸ’¥
                style: [
                    // ãƒãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«
                    { selector: '.ros2_node', style: { 'background-color': '#1E90FF', 'label': 'data(label)', 'text-valign': 'center', 'color': '#fff', 'text-outline-color': '#000', 'text-outline-width': 1, 'shape': 'round-rectangle', 'width': 'label', 'height': 40, 'padding': '10px' } },
                    
                    // ğŸ’¥ ä¿®æ­£ç‚¹: ãƒˆãƒ”ãƒƒã‚¯ãƒãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¾©æ´» ğŸ’¥
                    { selector: '.ros2_topic', style: { 'background-color': '#3CB371', 'label': 'data(label)', 'text-valign': 'center', 'color': '#fff', 'shape': 'ellipse', 'width': 'label', 'height': 30, 'padding': '10px' } },

                    { selector: 'node[label]', style: { 'min-width': '60px', 'text-wrap': 'wrap', 'text-max-width': '80px', 'font-size': '10px' } },
                    
                    // ã‚¨ãƒƒã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ«: ãƒ©ãƒ™ãƒ«ã‚’ publish/subscribe ã«æˆ»ã—ã€curve-style ã‚’ bezier ã«æˆ»ã™ 
                    { selector: '.edge_topic_pub, .edge_topic_sub', style: { 
                        'width': 3, 
                        'line-color': '#3CB371', 
                        'target-arrow-color': '#3CB371', 
                        'target-arrow-shape': 'triangle', 
                        'curve-style': 'bezier', // ğŸ’¥ ä¿®æ­£ç‚¹: bezier ã«æˆ»ã™ ğŸ’¥
                        'label': 'data(label)', // ğŸ’¥ ä¿®æ­£ç‚¹: publish/subscribe ã«æˆ»ã™ ğŸ’¥
                        'font-size': '10px',      
                        'text-outline-color': '#fff',
                        'text-outline-width': 2 
                    } },
                ]
            });

            // --- ğŸ’¥ ä¿®æ­£ç‚¹ï¼šã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–æ€§ã®å®Ÿè£… (ã‚¯ãƒªãƒƒã‚¯ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯) ğŸ’¥ ---
            
            // ãƒãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã®å‡¦ç† (ros2_node ã¾ãŸã¯ ros2_topic)
            cy.on('tap', 'node', function(evt){
                let element = evt.target;
                let data = element.data();
                
                let typeLabel = data.ros2_type === 'node' ? 'ãƒãƒ¼ãƒ‰' : 'ãƒˆãƒ”ãƒƒã‚¯';
                let details = data.details ? JSON.stringify(data.details, null, 2) : 
                              `ID: ${data.id}\nROS2 Type: ${data.ros2_type}\n(è©³ç´°ãƒ‡ãƒ¼ã‚¿ãªã—)`;

                let output = `--- [${typeLabel}: ${data.label}] ---\nID: ${data.id}\n--------------------\n${details}`;

                document.getElementById('details-panel').textContent = output;
            });
            
            // ã‚¨ãƒƒã‚¸ (çŸ¢å°) ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã®å‡¦ç†
            cy.on('tap', 'edge', function(evt){
                let element = evt.target;
                let data = element.data();
                
                // ã‚¨ãƒƒã‚¸ã®è©³ç´°ãƒ‡ãƒ¼ã‚¿ (ã“ã“ã§ã¯æ¥ç¶šæƒ…å ±è‡ªä½“)
                let details = data.details ? JSON.stringify(data.details, null, 2) : 
                              `ID: ${data.id}\nROS2 Type: ${data.ros2_type}\n(è©³ç´°ãƒ‡ãƒ¼ã‚¿ãªã—)`;

                let output = `--- [æ¥ç¶š: ${data.label}] ---\né€šä¿¡å…ƒ: ${data.source}\né€šä¿¡å…ˆ: ${data.target}\n--------------------\n${details}`;

                document.getElementById('details-panel').textContent = output;
            });

            // --- SVGå‡ºåŠ›ã®å®Ÿè£… ---
            document.getElementById('export-svg-btn').addEventListener('click', function() {

                if (typeof cy.svg !== 'function') {
                    alert('ã‚¨ãƒ©ãƒ¼: SVGã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚µã‚¤ã‚ºã‚’2å€ã«æ‹¡å¤§ (scale: 2)
                let svg = cy.svg({ scale: 2, full: true });

                // SVGãƒ‡ãƒ¼ã‚¿ã‚’Blobã«å¤‰æ›
                let blob = new Blob([svg], { type: 'image/svg+xml' });
                let url = URL.createObjectURL(blob);

                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹
                let a = document.createElement('a');
                a.href = url;
                a.download = 'ros2_graph_diagram.svg';
                document.body.appendChild(a);
                a.click();

                // å¾Œå‡¦ç†
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                setTimeout(() => {
                    alert('ros2_graph_diagram.svgã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚Œã¾ã—ãŸã€‚');
                }, 100);
            });
        });
    </script>
</body>
</html>